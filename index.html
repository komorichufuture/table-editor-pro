<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>表エディタ Pro - シンプル版</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
    }
    
    #app {
      min-height: 100vh;
      padding: 20px;
    }
    
    #controls {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn.secondary {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      color: #744210;
    }
    
    .btn.danger {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
      color: white;
    }
    
    #tables-container {
      display: flex;
      flex-direction: column;
      gap: 30px;
    }
    
    .table-wrapper {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .table-title {
      font-size: 18px;
      font-weight: bold;
      color: #4c51bf;
      background: rgba(102, 126, 234, 0.1);
      padding: 8px 15px;
      border-radius: 8px;
      border: none;
      outline: none;
    }
    
    .table-controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .table-controls .btn {
      font-size: 12px;
      padding: 6px 12px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    td {
      border: 2px solid rgba(102, 126, 234, 0.2);
      min-width: 120px;
      min-height: 80px;
      padding: 8px;
      text-align: center;
      vertical-align: middle;
      background: white;
      transition: all 0.2s ease;
      position: relative;
    }
    
    td:hover {
      background: rgba(102, 126, 234, 0.05);
      border-color: rgba(102, 126, 234, 0.4);
    }
    
    td[contenteditable="true"] {
      outline: none;
      cursor: text;
    }
    
    td[contenteditable="true"]:focus {
      background: rgba(102, 126, 234, 0.1);
      border-color: rgba(102, 126, 234, 0.6);
      box-shadow: inset 0 0 0 2px rgba(102, 126, 234, 0.3);
    }
    
    .placeholder {
      color: #999;
      font-style: italic;
      font-size: 14px;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
    }
    
    .file-input {
      display: none;
    }
    
    @media (max-width: 768px) {
      #app {
        padding: 10px;
      }
      
      #controls {
        padding: 15px;
      }
      
      .btn {
        font-size: 12px;
        padding: 10px 15px;
      }
      
      td {
        min-width: 80px;
        min-height: 60px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="controls">
      <button class="btn" onclick="createNewTable()">📊 新しい表</button>
      <button class="btn secondary" onclick="saveToLocalStorage()">💾 保存</button>
      <button class="btn secondary" onclick="loadFromLocalStorage()">📂 復元</button>
      <button class="btn" onclick="exportToJSON()">📤 JSONエクスポート</button>
      <button class="btn" onclick="importFromJSON()">📁 JSONインポート</button>
      <button class="btn danger" onclick="clearAllTables()">🗑️ 全削除</button>
    </div>
    
    <div id="tables-container">
      <!-- 表がここに動的に追加される -->
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <input type="file" id="json-file-input" class="file-input" accept=".json">

  <script>
    let tableCount = 0;
    let tables = [];

    // トースト通知
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // 新しい表を作成
    function createNewTable() {
      try {
        tableCount++;
        const tableId = `table-${Date.now()}`;
        
        const tableData = {
          id: tableId,
          title: `表 ${tableCount}`,
          rows: [
            ['', '', ''],
            ['', '', ''],
            ['', '', '']
          ]
        };
        
        tables.push(tableData);
        renderTable(tableData);
        showToast('📊 新しい表を作成しました');
        console.log('新しい表を作成:', tableData);
      } catch (error) {
        console.error('表作成エラー:', error);
        showToast('表の作成に失敗しました', 'error');
      }
    }

    // 表をHTMLに描画
    function renderTable(tableData) {
      try {
        const container = document.getElementById('tables-container');
        
        const wrapper = document.createElement('div');
        wrapper.className = 'table-wrapper';
        wrapper.setAttribute('data-table-id', tableData.id);
        
        // ヘッダー
        const header = document.createElement('div');
        header.className = 'table-header';
        
        const titleInput = document.createElement('input');
        titleInput.className = 'table-title';
        titleInput.value = tableData.title;
        titleInput.addEventListener('input', function() {
          updateTableTitle(tableData.id, this.value);
        });
        
        const controls = document.createElement('div');
        controls.className = 'table-controls';
        controls.innerHTML = `
          <button class="btn" onclick="addRow('${tableData.id}')">➕ 行</button>
          <button class="btn" onclick="addColumn('${tableData.id}')">➕ 列</button>
          <button class="btn danger" onclick="removeRow('${tableData.id}')">➖ 行</button>
          <button class="btn danger" onclick="removeColumn('${tableData.id}')">➖ 列</button>
          <button class="btn danger" onclick="deleteTable('${tableData.id}')">🗑️ 削除</button>
        `;
        
        header.appendChild(titleInput);
        header.appendChild(controls);
        wrapper.appendChild(header);
        
        // テーブル
        const table = document.createElement('table');
        table.id = `table-${tableData.id}`;
        
        for (let i = 0; i < tableData.rows.length; i++) {
          const tr = document.createElement('tr');
          for (let j = 0; j < tableData.rows[i].length; j++) {
            const td = document.createElement('td');
            td.setAttribute('contenteditable', 'true');
            td.setAttribute('data-row', i);
            td.setAttribute('data-col', j);
            
            if (tableData.rows[i][j]) {
              td.innerHTML = tableData.rows[i][j];
            } else {
              td.innerHTML = '<span class="placeholder">クリックして入力</span>';
            }
            
            // セルイベント
            td.addEventListener('focus', function() {
              if (this.innerHTML.includes('placeholder')) {
                this.innerHTML = '';
              }
            });
            
            td.addEventListener('blur', function() {
              const row = parseInt(this.getAttribute('data-row'));
              const col = parseInt(this.getAttribute('data-col'));
              updateCellData(tableData.id, row, col, this.innerHTML);
              
              if (!this.innerHTML.trim()) {
                this.innerHTML = '<span class="placeholder">クリックして入力</span>';
              }
            });
            
            td.addEventListener('keydown', function(e) {
              if (e.key === 'Enter') {
                e.preventDefault();
                document.execCommand('insertHTML', false, '<br>');
              }
            });
            
            tr.appendChild(td);
          }
          table.appendChild(tr);
        }
        
        wrapper.appendChild(table);
        container.appendChild(wrapper);
        
        console.log('表を描画完了:', tableData.id);
      } catch (error) {
        console.error('表描画エラー:', error);
        showToast('表の描画に失敗しました', 'error');
      }
    }

    // セルデータ更新
    function updateCellData(tableId, row, col, content) {
      try {
        const table = tables.find(t => t.id === tableId);
        if (table && table.rows[row]) {
          table.rows[row][col] = content;
        }
      } catch (error) {
        console.error('セルデータ更新エラー:', error);
      }
    }

    // 表タイトル更新
    function updateTableTitle(tableId, title) {
      try {
        const table = tables.find(t => t.id === tableId);
        if (table) {
          table.title = title;
        }
      } catch (error) {
        console.error('タイトル更新エラー:', error);
      }
    }

    // 行追加
    function addRow(tableId) {
      try {
        const table = tables.find(t => t.id === tableId);
        if (table) {
          const colCount = table.rows[0].length;
          const newRow = new Array(colCount).fill('');
          table.rows.push(newRow);
          refreshTable(tableId);
          showToast('行を追加しました');
        }
      } catch (error) {
        console.error('行追加エラー:', error);
        showToast('行の追加に失敗しました', 'error');
      }
    }

    // 列追加
    function addColumn(tableId) {
      try {
        const table = tables.find(t => t.id === tableId);
        if (table) {
          table.rows.forEach(row => row.push(''));
          refreshTable(tableId);
          showToast('列を追加しました');
        }
      } catch (error) {
        console.error('列追加エラー:', error);
        showToast('列の追加に失敗しました', 'error');
      }
    }

    // 行削除
    function removeRow(tableId) {
      try {
        const table = tables.find(t => t.id === tableId);
        if (table && table.rows.length > 1) {
          table.rows.pop();
          refreshTable(tableId);
          showToast('行を削除しました');
        }
      } catch (error) {
        console.error('行削除エラー:', error);
      }
    }

    // 列削除
    function removeColumn(tableId) {
      try {
        const table = tables.find(t => t.id === tableId);
        if (table && table.rows[0].length > 1) {
          table.rows.forEach(row => row.pop());
          refreshTable(tableId);
          showToast('列を削除しました');
        }
      } catch (error) {
        console.error('列削除エラー:', error);
      }
    }

    // 表削除
    function deleteTable(tableId) {
      try {
        if (confirm('この表を削除しますか？')) {
          tables = tables.filter(t => t.id !== tableId);
          const wrapper = document.querySelector(`[data-table-id="${tableId}"]`);
          if (wrapper) {
            wrapper.remove();
          }
          showToast('表を削除しました');
        }
      } catch (error) {
        console.error('表削除エラー:', error);
      }
    }

    // 表を再描画
    function refreshTable(tableId) {
      try {
        const wrapper = document.querySelector(`[data-table-id="${tableId}"]`);
        const table = tables.find(t => t.id === tableId);
        if (wrapper && table) {
          wrapper.remove();
          renderTable(table);
        }
      } catch (error) {
        console.error('表再描画エラー:', error);
      }
    }

    // ローカルストレージに保存
    function saveToLocalStorage() {
      try {
        localStorage.setItem('tableEditorData', JSON.stringify(tables));
        localStorage.setItem('tableEditorSaveTime', new Date().toISOString());
        showToast('💾 データを保存しました');
        console.log('保存完了:', tables);
      } catch (error) {
        console.error('保存エラー:', error);
        showToast('保存に失敗しました', 'error');
      }
    }

    // ローカルストレージから復元
    function loadFromLocalStorage() {
      try {
        const savedData = localStorage.getItem('tableEditorData');
        if (savedData) {
          tables = JSON.parse(savedData);
          document.getElementById('tables-container').innerHTML = '';
          tables.forEach(table => renderTable(table));
          tableCount = tables.length;
          showToast('📂 データを復元しました');
          console.log('復元完了:', tables);
        } else {
          showToast('保存されたデータがありません', 'error');
        }
      } catch (error) {
        console.error('復元エラー:', error);
        showToast('データの復元に失敗しました', 'error');
      }
    }

    // JSONエクスポート
    function exportToJSON() {
      try {
        if (tables.length === 0) {
          showToast('エクスポートする表がありません', 'error');
          return;
        }
        
        const exportData = {
          version: '1.0',
          exportDate: new Date().toISOString(),
          tables: tables
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], {
          type: 'application/json'
        });
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `table-data-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('📤 JSONファイルを保存しました');
        console.log('エクスポート完了:', exportData);
      } catch (error) {
        console.error('エクスポートエラー:', error);
        showToast('エクスポートに失敗しました', 'error');
      }
    }

    // JSONインポート
    function importFromJSON() {
      try {
        const fileInput = document.getElementById('json-file-input');
        fileInput.click();
      } catch (error) {
        console.error('インポート開始エラー:', error);
        showToast('ファイル選択に失敗しました', 'error');
      }
    }

    // ファイル選択時の処理
    document.getElementById('json-file-input').addEventListener('change', function(e) {
      try {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(event) {
          try {
            const importData = JSON.parse(event.target.result);
            const importTables = importData.tables || importData;
            
            if (confirm('既存の表を削除して新しいデータを読み込みますか？')) {
              tables = importTables;
              document.getElementById('tables-container').innerHTML = '';
              tables.forEach(table => renderTable(table));
              tableCount = tables.length;
              showToast(`📁 ${tables.length}個の表を読み込みました`);
              console.log('インポート完了:', tables);
            }
          } catch (error) {
            console.error('JSON解析エラー:', error);
            showToast('JSONファイルの形式が正しくありません', 'error');
          }
        };
        
        reader.onerror = function() {
          showToast('ファイルの読み込みに失敗しました', 'error');
        };
        
        reader.readAsText(file);
        
        // ファイル入力をリセット
        e.target.value = '';
      } catch (error) {
        console.error('ファイル処理エラー:', error);
        showToast('ファイルの処理に失敗しました', 'error');
      }
    });

    // 全削除
    function clearAllTables() {
      try {
        if (confirm('すべての表を削除しますか？この操作は取り消せません。')) {
          tables = [];
          tableCount = 0;
          document.getElementById('tables-container').innerHTML = '';
          localStorage.removeItem('tableEditorData');
          localStorage.removeItem('tableEditorSaveTime');
          showToast('🗑️ すべての表を削除しました');
        }
      } catch (error) {
        console.error('全削除エラー:', error);
      }
    }

    // ページ読み込み時の処理
    window.addEventListener('load', function() {
      try {
        showToast('🚀 表エディタが起動しました');
        
        // 自動保存データがあるかチェック
        setTimeout(() => {
          const savedData = localStorage.getItem('tableEditorData');
          if (savedData) {
            const saveTime = localStorage.getItem('tableEditorSaveTime');
            const timeStr = saveTime ? new Date(saveTime).toLocaleString() : '不明';
            if (confirm(`前回のデータがあります (${timeStr})。復元しますか？`)) {
              loadFromLocalStorage();
            }
          }
        }, 1000);
        
        console.log('アプリ初期化完了');
      } catch (error) {
        console.error('初期化エラー:', error);
      }
    });

    // キーボードショートカット
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case 'n':
            e.preventDefault();
            createNewTable();
            break;
          case 's':
            e.preventDefault();
            saveToLocalStorage();
            break;
        }
      }
    });

    // デバッグ用
    window.debugTables = function() {
      console.log('現在の表データ:', tables);
      console.log('表の数:', tables.length);
    };
  </script>
</body>
</html>

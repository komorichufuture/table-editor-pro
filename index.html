<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.5, maximum-scale=3.0">
  <title>è¡¨ã‚¨ãƒ‡ã‚£ã‚¿ Pro - å®Œå…¨ç‰ˆ</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100%;
      overflow: auto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
    }
    
    #viewport {
      position: relative;
      width: 100%;
      height: 100vh;
      overflow: auto;
      cursor: grab;
    }
    
    #viewport:active {
      cursor: grabbing;
    }
    
    #viewport.panning {
      cursor: grabbing;
    }
    
    #background {
      position: absolute;
      top: 0;
      left: 0;
      width: 4000px;
      height: 3000px;
      background: 
        linear-gradient(to right, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
      background-size: 50px 50px;
      z-index: 0;
    }
    
    #controls {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(15px);
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      max-width: 350px;
    }
    
    .control-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 14px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }
    
    .control-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    
    .secondary-btn {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      color: #744210;
    }
    
    .secondary-btn:hover {
      box-shadow: 0 8px 25px rgba(252, 182, 159, 0.3);
    }
    
    .success-btn {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      color: #2d3748;
    }
    
    .success-btn:hover {
      box-shadow: 0 8px 25px rgba(168, 237, 234, 0.3);
    }
    
    .danger-btn {
      background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
      color: #742a2a;
    }
    
    .danger-btn:hover {
      box-shadow: 0 8px 25px rgba(255, 154, 158, 0.3);
    }
    
    .draggable-table {
      position: absolute;
      border: 3px solid rgba(255, 255, 255, 0.4);
      background-color: rgba(255, 255, 255, 0.95);
      cursor: move;
      z-index: 10;
      overflow: visible;
      min-width: 180px;
      padding: 15px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(15px);
      transition: all 0.3s ease;
    }
    
    .draggable-table:hover {
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.2);
      transform: translateY(-5px);
    }
    
    .draggable-table.dragging {
      transform: rotate(5deg) scale(1.05);
      box-shadow: 0 30px 100px rgba(0, 0, 0, 0.3);
      z-index: 100;
    }
    
    table {
      border-collapse: collapse;
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    td {
      border: 2px solid rgba(102, 126, 234, 0.2);
      width: 140px;
      height: 90px;
      text-align: center;
      vertical-align: middle;
      background: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
      position: relative;
      font-size: 14px;
      line-height: 1.4;
    }
    
    td:hover {
      background: rgba(102, 126, 234, 0.08);
      border-color: rgba(102, 126, 234, 0.4);
    }
    
    td[contenteditable="true"] {
      outline: none;
    }
    
    td[contenteditable="true"]:focus {
      background: rgba(102, 126, 234, 0.15);
      box-shadow: inset 0 0 0 3px rgba(102, 126, 234, 0.6);
      border-radius: 8px;
      border-color: rgba(102, 126, 234, 0.6);
    }
    
    .table-title {
      text-align: center;
      font-weight: bold;
      color: #4c51bf;
      margin-bottom: 12px;
      font-size: 16px;
      padding: 8px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 10px;
      border: 2px solid rgba(102, 126, 234, 0.2);
    }
    
    .toolbar {
      margin-bottom: 15px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .toolbar-btn {
      background: rgba(102, 126, 234, 0.15);
      color: #4c51bf;
      border: 2px solid rgba(102, 126, 234, 0.3);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .toolbar-btn:hover {
      background: rgba(102, 126, 234, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
    }
    
    .delete-btn {
      background: rgba(239, 68, 68, 0.15);
      color: #dc2626;
      border-color: rgba(239, 68, 68, 0.3);
    }
    
    .delete-btn:hover {
      background: rgba(239, 68, 68, 0.25);
      box-shadow: 0 5px 15px rgba(239, 68, 68, 0.2);
    }
    
    /* ç”»åƒé–¢é€£ã‚¹ã‚¿ã‚¤ãƒ« */
    .image-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      padding: 5px;
      height: 100%;
      justify-content: center;
    }
    
    .cell-image {
      max-width: 120px;
      max-height: 70px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    
    .cell-image:hover {
      transform: scale(1.05);
    }
    
    .image-upload-area {
      width: 120px;
      height: 70px;
      border: 2px dashed rgba(102, 126, 234, 0.4);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(102, 126, 234, 0.05);
    }
    
    .image-upload-area:hover {
      border-color: rgba(102, 126, 234, 0.6);
      background: rgba(102, 126, 234, 0.1);
      transform: scale(1.02);
    }
    
    .image-upload-area.drag-over {
      border-color: rgba(102, 126, 234, 0.8);
      background: rgba(102, 126, 234, 0.2);
    }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(15px);
    }
    
    .modal h3 {
      margin: 0 0 20px 0;
      color: #4c51bf;
      text-align: center;
      font-size: 20px;
    }
    
    .modal input, .modal textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid rgba(102, 126, 234, 0.3);
      border-radius: 12px;
      font-size: 16px;
      margin-bottom: 15px;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    
    .modal input:focus, .modal textarea:focus {
      outline: none;
      border-color: rgba(102, 126, 234, 0.6);
    }
    
    .modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    
    .modal-btn {
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    
    .modal-btn.cancel {
      border: 2px solid rgba(102, 126, 234, 0.3);
      background: white;
      color: #4c51bf;
    }
    
    .modal-btn.primary {
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .modal-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    /* æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .toast {
      position: fixed;
      top: 100px;
      right: 20px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 15px 25px;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
      z-index: 1001;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.4s ease;
      font-weight: 600;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .toast.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 768px) {
      #controls {
        position: relative;
        margin: 15px;
        width: calc(100% - 30px);
        max-width: none;
      }
      
      .draggable-table {
        position: relative;
        margin: 20px auto;
        width: calc(100% - 40px);
        cursor: default;
      }
      
      td {
        width: 100px;
        height: 70px;
        font-size: 12px;
      }
      
      .cell-image {
        max-width: 80px;
        max-height: 50px;
      }
      
      .image-upload-area {
        width: 80px;
        height: 50px;
      }
    }
    
    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .draggable-table {
      animation: fadeInUp 0.5s ease-out;
    }
    
    /* ãƒªãƒ³ã‚¯ã‚¹ã‚¿ã‚¤ãƒ« */
    .cell-link {
      color: #667eea;
      text-decoration: none;
      border-bottom: 1px dashed #667eea;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .cell-link:hover {
      color: #4c51bf;
      border-bottom: 1px solid #4c51bf;
    }
    
    /* å…±æœ‰æ©Ÿèƒ½ */
    .share-url {
      background: rgba(102, 126, 234, 0.1);
      border: 2px solid rgba(102, 126, 234, 0.3);
      padding: 10px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 14px;
      word-break: break-all;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div id="viewport">
    <div id="background"></div>
    
    <div id="controls">
      <button class="control-btn" onclick="createTable()">ğŸ“Š æ–°ã—ã„è¡¨</button>
      <button class="control-btn secondary-btn" onclick="saveData()">ğŸ’¾ ä¿å­˜</button>
      <button class="control-btn success-btn" onclick="loadData()">ğŸ“ èª­ã¿è¾¼ã¿</button>
      <button class="control-btn" onclick="exportJSON()">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="control-btn" onclick="showShareModal()">ğŸ”— å…±æœ‰</button>
      <button class="control-btn" onclick="expandWorkspace()">ğŸ“„ æ‹¡å¼µ</button>
      <button class="control-btn danger-btn" onclick="clearAll()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    let tableCount = 0;
    const colors = [
      'rgba(254, 202, 202, 0.9)', // è–„ã„èµ¤
      'rgba(187, 247, 208, 0.9)', // è–„ã„ç·‘
      'rgba(191, 219, 254, 0.9)', // è–„ã„é’
      'rgba(254, 240, 138, 0.9)', // è–„ã„é»„
      'rgba(196, 181, 253, 0.9)', // è–„ã„ç´«
      'rgba(253, 230, 138, 0.9)'  // è–„ã„ã‚ªãƒ¬ãƒ³ã‚¸
    ];
    const gridSize = 50;

    // è‡ªå‹•ä¿å­˜æ©Ÿèƒ½
    let autoSaveTimer;
    
    function startAutoSave() {
      clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(() => {
        saveData(true); // ã‚µã‚¤ãƒ¬ãƒ³ãƒˆä¿å­˜
      }, 5000); // 5ç§’å¾Œã«è‡ªå‹•ä¿å­˜
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function createEditableCell(content = '') {
      const td = document.createElement('td');
      td.setAttribute('contenteditable', 'true');
      
      if (!content.trim()) {
        td.innerHTML = `<span style="color: #999; font-style: italic;">ã‚¯ãƒªãƒƒã‚¯ã€ç”»åƒãƒ‰ãƒ­ãƒƒãƒ—ã€ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›</span>`;
      } else {
        td.innerHTML = content;
        // æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒªãƒ³ã‚¯å¤‰æ›
        setTimeout(() => convertUrlsToLinks(td), 100);
      }
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®å‡¦ç†
      td.addEventListener('focus', function() {
        if (this.innerHTML.includes('ã‚¯ãƒªãƒƒã‚¯ã€ç”»åƒãƒ‰ãƒ­ãƒƒãƒ—')) {
          this.innerHTML = '';
        }
      });
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¢ã‚¦ãƒˆæ™‚ã®å‡¦ç†
      td.addEventListener('blur', function() {
        if (!this.innerHTML.trim() || this.innerHTML === '<br>') {
          this.innerHTML = `<span style="color: #999; font-style: italic;">ã‚¯ãƒªãƒƒã‚¯ã€ç”»åƒãƒ‰ãƒ­ãƒƒãƒ—ã€ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›</span>`;
        } else {
          convertUrlsToLinks(this);
        }
        startAutoSave(); // å¤‰æ›´æ™‚ã«è‡ªå‹•ä¿å­˜ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
      });
      
      // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œ
      td.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.style.background = 'rgba(102, 126, 234, 0.2)';
      });
      
      td.addEventListener('dragleave', function(e) {
        this.style.background = '';
      });
      
      td.addEventListener('drop', function(e) {
        e.preventDefault();
        this.style.background = '';
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) {
          handleImageUpload(files[0], this);
        }
      });
      
      // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      td.addEventListener('dblclick', function() {
        if (!this.querySelector('.cell-image')) {
          selectImageFile(this);
        }
      });
      
      // ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã§æ”¹è¡Œ
      td.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.execCommand('insertHTML', false, '<br>');
        }
      });
      
      return td;
    }

    function handleImageUpload(file, cell) {
      if (file.size > 5 * 1024 * 1024) { // 5MBåˆ¶é™
        showToast('ç”»åƒã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.className = 'cell-image';
        img.alt = file.name;
        
        // ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§å¤‰æ›´
        img.addEventListener('click', function(event) {
          event.stopPropagation();
          selectImageFile(cell);
        });
        
        cell.innerHTML = '';
        cell.appendChild(img);
        cell.setAttribute('contenteditable', 'false');
        
        showToast('ğŸ“¸ ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
        startAutoSave();
      };
      
      reader.onerror = function() {
        showToast('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      };
      
      reader.readAsDataURL(file);
    }

    function selectImageFile(cell) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.style.display = 'none';
      
      input.addEventListener('change', function() {
        if (this.files.length > 0) {
          handleImageUpload(this.files[0], cell);
        }
        document.body.removeChild(input);
      });
      
      document.body.appendChild(input);
      input.click();
    }

    function convertUrlsToLinks(element) {
      if (document.activeElement === element) return;
      
      const urlRegex = /(https?:\/\/[^\s<>"]+)/gi;
      const text = element.innerHTML;
      
      if (text.includes('<a href=') || text.includes('<img')) return;
      
      const linkedText = text.replace(urlRegex, function(url) {
        const displayUrl = url.length > 25 ? url.substring(0, 22) + '...' : url;
        return `<a href="${url}" target="_blank" class="cell-link" onclick="event.stopPropagation()">${displayUrl}</a>`;
      });
      
      if (linkedText !== text) {
        element.innerHTML = linkedText;
        showToast('ğŸ”— URLã‚’ãƒªãƒ³ã‚¯ã«å¤‰æ›ã—ã¾ã—ãŸ');
      }
    }

    function createTable(data = null) {
      const wrapper = document.createElement('div');
      wrapper.className = 'draggable-table';
      wrapper.setAttribute('data-table-id', Date.now().toString());

      if (data) {
        wrapper.style.top = data.top;
        wrapper.style.left = data.left;
        wrapper.style.backgroundColor = data.color;
        wrapper.setAttribute('data-table-id', data.id || Date.now().toString());
      } else {
        wrapper.style.top = (150 + tableCount * 100) + 'px';
        wrapper.style.left = (150 + 250 * (tableCount % 4)) + 'px';
        wrapper.style.backgroundColor = colors[tableCount % colors.length];
        tableCount++;
      }

      // ã‚¿ã‚¤ãƒˆãƒ«
      const title = document.createElement('div');
      title.className = 'table-title';
      title.textContent = data?.title || `è¡¨ ${tableCount}`;
      title.contentEditable = true;
      title.addEventListener('blur', startAutoSave);
      wrapper.appendChild(title);

      // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼
      const toolbar = document.createElement('div');
      toolbar.className = 'toolbar';

      const buttons = [
        { text: 'â• åˆ—', action: () => addColumn(table) },
        { text: 'â– åˆ—', action: () => removeColumn(table), class: 'delete-btn' },
        { text: 'â• è¡Œ', action: () => addRow(table) },
        { text: 'â– è¡Œ', action: () => removeRow(table), class: 'delete-btn' },
        { text: 'ğŸ—‘ï¸ å‰Šé™¤', action: () => deleteTable(wrapper), class: 'delete-btn' }
      ];

      buttons.forEach(btn => {
        const button = document.createElement('button');
        button.className = `toolbar-btn ${btn.class || ''}`;
        button.textContent = btn.text;
        button.onclick = btn.action;
        toolbar.appendChild(button);
      });

      wrapper.appendChild(toolbar);

      // ãƒ†ãƒ¼ãƒ–ãƒ«
      const table = document.createElement('table');

      if (data && data.rows) {
        for (const rowData of data.rows) {
          const tr = document.createElement('tr');
          for (const cellHTML of rowData) {
            const td = createEditableCell(cellHTML);
            tr.appendChild(td);
          }
          table.appendChild(tr);
        }
      } else {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§3x3ã®è¡¨ã‚’ä½œæˆ
        for (let i = 0; i < 3; i++) {
          const tr = document.createElement('tr');
          for (let j = 0; j < 3; j++) {
            tr.appendChild(createEditableCell());
          }
          table.appendChild(tr);
        }
      }

      wrapper.appendChild(table);
      document.getElementById('viewport').appendChild(wrapper);
      makeDraggable(wrapper);
      
      if (!data) {
        showToast('ğŸ“Š æ–°ã—ã„è¡¨ã‚’ä½œæˆã—ã¾ã—ãŸ');
        startAutoSave();
      }
    }

    function addColumn(table) {
      for (const row of table.rows) {
        row.appendChild(createEditableCell());
      }
      showToast('åˆ—ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      startAutoSave();
    }

    function removeColumn(table) {
      const colCount = table.rows[0].cells.length;
      if (colCount > 1) {
        for (const row of table.rows) {
          row.deleteCell(colCount - 1);
        }
        showToast('åˆ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        startAutoSave();
      }
    }

    function addRow(table) {
      const newRow = document.createElement('tr');
      const colCount = table.rows[0].cells.length;
      for (let i = 0; i < colCount; i++) {
        newRow.appendChild(createEditableCell());
      }
      table.appendChild(newRow);
      showToast('è¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      startAutoSave();
    }

    function removeRow(table) {
      if (table.rows.length > 1) {
        table.deleteRow(-1);
        showToast('è¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        startAutoSave();
      }
    }

    function deleteTable(wrapper) {
      if (confirm('ã“ã®è¡¨ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        wrapper.remove();
        showToast('è¡¨ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        startAutoSave();
      }
    }

    function makeDraggable(el) {
      let offsetX, offsetY;
      let isDragging = false;
      
      el.onmousedown = function (e) {
        if (e.target.closest('button') || 
            e.target.tagName === 'TD' || 
            e.target.isContentEditable ||
            e.target.closest('.toolbar')) {
          return;
        }
        
        isDragging = true;
        el.classList.add('dragging');
        offsetX = e.clientX - el.offsetLeft;
        offsetY = e.clientY - el.offsetTop;
        
        document.onmousemove = function (e) {
          if (!isDragging) return;
          let left = Math.round((e.clientX - offsetX) / gridSize) * gridSize;
          let top = Math.round((e.clientY - offsetY) / gridSize) * gridSize;
          el.style.left = left + 'px';
          el.style.top = top + 'px';
        };
        
        document.onmouseup = () => {
          isDragging = false;
          el.classList.remove('dragging');
          document.onmousemove = null;
          document.onmouseup = null;
          startAutoSave();
        };
      };
    }

    function saveData(silent = false) {
      const tables = document.querySelectorAll('.draggable-table');
      const data = [];
      
      for (const tableDiv of tables) {
        const table = tableDiv.querySelector('table');
        const title = tableDiv.querySelector('.table-title').textContent;
        const rows = [];
        
        for (const tr of table.rows) {
          const cells = [];
          for (const td of tr.cells) {
            cells.push(td.innerHTML);
          }
          rows.push(cells);
        }
        
        data.push({
          id: tableDiv.getAttribute('data-table-id'),
          title: title,
          top: tableDiv.style.top,
          left: tableDiv.style.left,
          color: tableDiv.style.backgroundColor,
          rows: rows
        });
      }
      
      try {
        localStorage.setItem('tableEditorData', JSON.stringify(data));
        localStorage.setItem('tableEditorSaveTime', new Date().toISOString());
        if (!silent) {
          showToast('ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    function loadData() {
      try {
        const savedData = localStorage.getItem('tableEditorData');
        if (!savedData) {
          showToast('ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
          return;
        }
        
        // æ—¢å­˜ã®è¡¨ã‚’å‰Šé™¤
        document.querySelectorAll('.draggable-table').forEach(el => el.remove());
        
        const data = JSON.parse(savedData);
        tableCount = 0;
        
        for (const tableData of data) {
          createTable(tableData);
        }
        
        const saveTime = localStorage.getItem('tableEditorSaveTime');
        const timeStr = saveTime ? new Date(saveTime).toLocaleString() : 'ä¸æ˜';
        showToast(`ğŸ“ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (ä¿å­˜: ${timeStr})`);
      } catch (error) {
        showToast('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    function exportJSON() {
      const tables = document.querySelectorAll('.draggable-table');
      if (tables.length === 0) {
        showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹è¡¨ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
      }
      
      const data = [];
      for (const tableDiv of tables) {
        const table = tableDiv.querySelector('table');
        const title = tableDiv.querySelector('.table-title').textContent;
        const rows = [];
        
        for (const tr of table.rows) {
          const cells = [];
          for (const td of tr.cells) {
            cells.push(td.innerHTML);
          }
          rows.push(cells);
        }
        
        data.push({
          id: tableDiv.getAttribute('data-table-id'),
          title: title,
          top: tableDiv.style.top,
          left: tableDiv.style.left,
          color: tableDiv.style.backgroundColor,
          rows: rows
        });
      }
      
      const exportData = {
        version: '2.0',
        exportDate: new Date().toISOString(),
        tableCount: data.length,
        tables: data
      };
      
      const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `table_data_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('ğŸ“¤ JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
    }

    function importJSON() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.style.display = 'none';
      
      input.addEventListener('change', function() {
        const file = this.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const importData = JSON.parse(e.target.result);
            const data = importData.tables || importData; // v2.0å½¢å¼ã¨v1.0å½¢å¼ã®ä¸¡æ–¹ã«å¯¾å¿œ
            
            // æ—¢å­˜ã®è¡¨ã‚’å‰Šé™¤
            if (confirm('æ—¢å­˜ã®è¡¨ã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ')) {
              document.querySelectorAll('.draggable-table').forEach(el => el.remove());
              tableCount = 0;
              
              for (const tableData of data) {
                createTable(tableData);
              }
              
              showToast(`ğŸ“ ${data.length}å€‹ã®è¡¨ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            }
          } catch (error) {
            showToast('JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
        };
        reader.readAsText(file);
        document.body.removeChild(input);
      });
      
      document.body.appendChild(input);
      input.click();
    }

    function showShareModal() {
      const tables = document.querySelectorAll('.draggable-table');
      if (tables.length === 0) {
        showToast('å…±æœ‰ã™ã‚‹è¡¨ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
      }
      
      // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const data = [];
      for (const tableDiv of tables) {
        const table = tableDiv.querySelector('table');
        const title = tableDiv.querySelector('.table-title').textContent;
        const rows = [];
        
        for (const tr of table.rows) {
          const cells = [];
          for (const td of tr.cells) {
            cells.push(td.innerHTML);
          }
          rows.push(cells);
        }
        
        data.push({
          id: tableDiv.getAttribute('data-table-id'),
          title: title,
          top: tableDiv.style.top,
          left: tableDiv.style.left,
          color: tableDiv.style.backgroundColor,
          rows: rows
        });
      }
      
      // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
      const encodedData = btoa(JSON.stringify(data));
      const shareUrl = `${window.location.origin}${window.location.pathname}?data=${encodedData}`;
      
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content">
          <h3>ğŸ”— è¡¨ã‚’å…±æœ‰</h3>
          <p>ä»¥ä¸‹ã®URLã‚’å…±æœ‰ã—ã¦ã€ä»–ã®äººãŒã‚ãªãŸã®è¡¨ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š</p>
          <div class="share-url">${shareUrl}</div>
          <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="this.closest('.modal').remove()">é–‰ã˜ã‚‹</button>
            <button class="modal-btn primary" onclick="copyShareUrl('${shareUrl}')">URLã‚’ã‚³ãƒ”ãƒ¼</button>
          </div>
          <p style="font-size: 12px; color: #666; margin-top: 15px;">
            âš ï¸ URLãŒéå¸¸ã«é•·ããªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã®å ´åˆã¯JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
          </p>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    function copyShareUrl(url) {
      navigator.clipboard.writeText(url).then(() => {
        showToast('ğŸ“‹ URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
        document.querySelector('.modal').remove();
      }).catch(() => {
        showToast('URLã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      });
    }

    function loadSharedData() {
      const urlParams = new URLSearchParams(window.location.search);
      const encodedData = urlParams.get('data');
      
      if (encodedData) {
        try {
          const data = JSON.parse(atob(encodedData));
          
          // æ—¢å­˜ã®è¡¨ã‚’å‰Šé™¤
          document.querySelectorAll('.draggable-table').forEach(el => el.remove());
          tableCount = 0;
          
          for (const tableData of data) {
            createTable(tableData);
          }
          
          showToast('ğŸ”— å…±æœ‰ã•ã‚ŒãŸè¡¨ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
          
          // URLã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ï¼ˆå±¥æ­´ã‚’æ±šã•ãªã„ãŸã‚ï¼‰
          window.history.replaceState({}, document.title, window.location.pathname);
        } catch (error) {
          showToast('å…±æœ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
      }
    }

    function expandWorkspace() {
      const bg = document.getElementById('background');
      bg.style.width = (bg.offsetWidth + 1500) + 'px';
      bg.style.height = (bg.offsetHeight + 1000) + 'px';
      showToast('ğŸ“„ ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’æ‹¡å¼µã—ã¾ã—ãŸ');
    }

    function clearAll() {
      if (confirm('ã™ã¹ã¦ã®è¡¨ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        document.querySelectorAll('.draggable-table').forEach(el => el.remove());
        localStorage.removeItem('tableEditorData');
        localStorage.removeItem('tableEditorSaveTime');
        tableCount = 0;
        showToast('ğŸ—‘ï¸ ã™ã¹ã¦ã®è¡¨ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      }
    }

    // ãƒ‘ãƒ³æ©Ÿèƒ½ã®å®Ÿè£…
    function initPanFunction() {
      const viewport = document.getElementById('viewport');
      let isPanning = false;
      let startX, startY, scrollLeft, scrollTop;

      viewport.addEventListener('mousedown', function(e) {
        if (e.target.closest('.draggable-table') || 
            e.target.closest('#controls') || 
            e.target.closest('.modal')) {
          return;
        }
        
        isPanning = true;
        viewport.classList.add('panning');
        startX = e.pageX - viewport.offsetLeft;
        startY = e.pageY - viewport.offsetTop;
        scrollLeft = viewport.scrollLeft;
        scrollTop = viewport.scrollTop;
        e.preventDefault();
      });

      viewport.addEventListener('mouseleave', function() {
        isPanning = false;
        viewport.classList.remove('panning');
      });

      viewport.addEventListener('mouseup', function() {
        isPanning = false;
        viewport.classList.remove('panning');
      });

      viewport.addEventListener('mousemove', function(e) {
        if (!isPanning) return;
        e.preventDefault();
        const x = e.pageX - viewport.offsetLeft;
        const y = e.pageY - viewport.offsetTop;
        const walkX = (x - startX) * 1.5;
        const walkY = (y - startY) * 1.5;
        viewport.scrollLeft = scrollLeft - walkX;
        viewport.scrollTop = scrollTop - walkY;
      });

      // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ
      viewport.addEventListener('touchstart', function(e) {
        if (e.target.closest('.draggable-table') || 
            e.target.closest('#controls')) {
          return;
        }
        // ã‚¿ãƒƒãƒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯è‡ªç„¶ã«ãƒãƒ³ãƒ‰ãƒ«ã•ã‚Œã‚‹
      }, { passive: true });
    }

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case 'n':
            e.preventDefault();
            createTable();
            break;
          case 's':
            e.preventDefault();
            saveData();
            break;
          case 'o':
            e.preventDefault();
            importJSON();
            break;
          case 'e':
            e.preventDefault();
            exportJSON();
            break;
        }
      }
    });

    // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹å‰ã®ç¢ºèª
    window.addEventListener('beforeunload', function(e) {
      const tables = document.querySelectorAll('.draggable-table');
      if (tables.length > 0) {
        const message = 'ä¿å­˜ã•ã‚Œã¦ã„ãªã„å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã¾ã™ã‹ï¼Ÿ';
        e.returnValue = message;
        return message;
      }
    });

    // åˆæœŸåŒ–
    window.onload = function() {
      initPanFunction();
      loadSharedData(); // å…±æœ‰ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°èª­ã¿è¾¼ã¿
      
      // è‡ªå‹•ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°èª­ã¿è¾¼ã¿ç¢ºèª
      const savedData = localStorage.getItem('tableEditorData');
      if (savedData && !new URLSearchParams(window.location.search).get('data')) {
        const saveTime = localStorage.getItem('tableEditorSaveTime');
        const timeStr = saveTime ? new Date(saveTime).toLocaleString() : 'ä¸æ˜';
        
        if (confirm(`è‡ªå‹•ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ (${timeStr})ã€‚èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ`)) {
          loadData();
        }
      }
      
      showToast('ğŸš€ è¡¨ã‚¨ãƒ‡ã‚£ã‚¿ Pro ãŒèµ·å‹•ã—ã¾ã—ãŸï¼');
      
      setTimeout(() => {
        if (window.innerWidth <= 768) {
          showToast('ğŸ“± ã‚¹ãƒãƒ›: èƒŒæ™¯ã‚¹ãƒ¯ã‚¤ãƒ—ã§ç§»å‹•ã€ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§ç”»åƒè¿½åŠ ');
        } else {
          showToast('ğŸ’» PC: Ctrl+N(æ–°è¦), Ctrl+S(ä¿å­˜), ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ç”»åƒè¿½åŠ ');
        }
      }, 3000);
    };
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>表エディタ Pro - 機能完全版</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      overflow: auto;
    }

    #viewport {
      position: relative;
      width: 100%;
      min-height: 100vh;
      overflow: auto;
      cursor: grab;
    }

    #viewport:active {
      cursor: grabbing;
    }

    #viewport.panning {
      cursor: grabbing;
    }

    #background {
      position: absolute;
      top: 0;
      left: 0;
      width: 3000px;
      height: 2000px;
      background: 
        linear-gradient(to right, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
      background-size: 40px 40px;
      z-index: 0;
    }
    
    #controls {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      max-width: 350px;
    }
    
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
    }
    
    .btn.secondary {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      color: #744210;
    }
    
    .btn.danger {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
      color: white;
    }
    
    .draggable-table {
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid rgba(102, 126, 234, 0.3);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      cursor: move;
      z-index: 10;
      min-width: 200px;
      transition: all 0.3s ease;
    }

    .draggable-table:hover {
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
      transform: translateY(-3px);
    }

    .draggable-table.dragging {
      transform: rotate(2deg) scale(1.02);
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
      z-index: 100;
      cursor: grabbing;
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: move;
    }
    
    .table-title {
      font-size: 16px;
      font-weight: bold;
      color: #4c51bf;
      background: rgba(102, 126, 234, 0.1);
      padding: 8px 15px;
      border-radius: 8px;
      border: none;
      outline: none;
      cursor: text;
    }
    
    .table-controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .table-controls .btn {
      font-size: 11px;
      padding: 6px 10px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    td {
      border: 2px solid rgba(102, 126, 234, 0.2);
      min-width: 120px;
      min-height: 80px;
      padding: 8px;
      text-align: center;
      vertical-align: middle;
      background: white;
      transition: all 0.2s ease;
      position: relative;
    }
    
    td:hover {
      background: rgba(102, 126, 234, 0.05);
      border-color: rgba(102, 126, 234, 0.4);
    }
    
    td[contenteditable="true"] {
      outline: none;
      cursor: text;
    }
    
    td[contenteditable="true"]:focus {
      background: rgba(102, 126, 234, 0.1);
      border-color: rgba(102, 126, 234, 0.6);
      box-shadow: inset 0 0 0 2px rgba(102, 126, 234, 0.3);
    }

    /* ドラッグ&ドロップエリア */
    .drop-zone {
      border: 2px dashed rgba(102, 126, 234, 0.4);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      background: rgba(102, 126, 234, 0.05);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .drop-zone:hover,
    .drop-zone.drag-over {
      border-color: rgba(102, 126, 234, 0.6);
      background: rgba(102, 126, 234, 0.1);
      transform: scale(1.02);
    }

    .drop-zone-text {
      color: #667eea;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .drop-zone-hint {
      color: #999;
      font-size: 12px;
    }

    /* 画像スタイル */
    .cell-image {
      max-width: 100px;
      max-height: 60px;
      border-radius: 6px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .cell-image:hover {
      transform: scale(1.1);
    }

    .placeholder {
      color: #999;
      font-style: italic;
      font-size: 14px;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
      z-index: 1001;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      font-weight: 600;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
    }
    
    .file-input {
      display: none;
    }

    /* リンクスタイル */
    .cell-link {
      color: #667eea;
      text-decoration: none;
      border-bottom: 1px dashed #667eea;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .cell-link:hover {
      color: #4c51bf;
      border-bottom: 1px solid #4c51bf;
    }
    
    @media (max-width: 768px) {
      #controls {
        position: relative;
        margin: 15px;
        width: calc(100% - 30px);
        max-width: none;
      }
      
      .draggable-table {
        position: relative;
        margin: 20px auto;
        width: calc(100% - 40px);
        cursor: default;
        transform: none !important;
      }

      .table-header {
        cursor: default;
      }
      
      .btn {
        font-size: 12px;
        padding: 10px 15px;
      }
      
      td {
        min-width: 80px;
        min-height: 60px;
        font-size: 12px;
      }

      .cell-image {
        max-width: 70px;
        max-height: 40px;
      }
    }
  </style>
</head>
<body>
  <div id="viewport">
    <div id="background"></div>
    
    <div id="controls">
      <button class="btn" onclick="createNewTable()">📊 新しい表</button>
      <button class="btn secondary" onclick="saveToLocalStorage()">💾 保存</button>
      <button class="btn secondary" onclick="loadFromLocalStorage()">📂 復元</button>
      <button class="btn" onclick="exportToJSON()">📤 JSONエクスポート</button>
      <button class="btn" onclick="importFromJSON()">📁 JSONインポート</button>
      <button class="btn" onclick="expandWorkspace()">📄 拡張</button>
      <button class="btn danger" onclick="clearAllTables()">🗑️ 全削除</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <input type="file" id="json-file-input" class="file-input" accept=".json">
  <input type="file" id="image-file-input" class="file-input" accept="image/*">

  <script>
    let tableCount = 0;
    let tables = [];
    let dragTarget = null;
    let isDragging = false;
    let dragOffset = { x: 0, y: 0 };

    // トースト通知
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // 新しい表を作成
    function createNewTable() {
      try {
        tableCount++;
        const tableId = `table-${Date.now()}`;
        
        const tableData = {
          id: tableId,
          title: `表 ${tableCount}`,
          x: 200 + (tableCount * 50),
          y: 150 + (tableCount * 50),
          rows: [
            ['', '', ''],
            ['', '', ''],
            ['', '', '']
          ]
        };
        
        tables.push(tableData);
        renderTable(tableData);
        showToast('📊 新しい表を作成しました');
        console.log('新しい表を作成:', tableData);
      } catch (error) {
        console.error('表作成エラー:', error);
        showToast('表の作成に失敗しました', 'error');
      }
    }

    // 表をHTMLに描画
    function renderTable(tableData) {
      try {
        const viewport = document.getElementById('viewport');
        
        const wrapper = document.createElement('div');
        wrapper.className = 'draggable-table';
        wrapper.setAttribute('data-table-id', tableData.id);
        wrapper.style.left = `${tableData.x}px`;
        wrapper.style.top = `${tableData.y}px`;
        
        // ヘッダー（ドラッグハンドル）
        const header = document.createElement('div');
        header.className = 'table-header';
        
        const titleInput = document.createElement('input');
        titleInput.className = 'table-title';
        titleInput.value = tableData.title;
        titleInput.addEventListener('input', function() {
          updateTableTitle(tableData.id, this.value);
        });
        titleInput.addEventListener('mousedown', function(e) {
          e.stopPropagation(); // タイトル編集時はドラッグしない
        });
        
        const controls = document.createElement('div');
        controls.className = 'table-controls';
        controls.innerHTML = `
          <button class="btn" onclick="addRow('${tableData.id}')">➕行</button>
          <button class="btn" onclick="addColumn('${tableData.id}')">➕列</button>
          <button class="btn danger" onclick="removeRow('${tableData.id}')">➖行</button>
          <button class="btn danger" onclick="removeColumn('${tableData.id}')">➖列</button>
          <button class="btn danger" onclick="deleteTable('${tableData.id}')">🗑️</button>
        `;
        
        header.appendChild(titleInput);
        header.appendChild(controls);
        wrapper.appendChild(header);
        
        // テーブル
        const table = document.createElement('table');
        table.id = `table-${tableData.id}`;
        
        for (let i = 0; i < tableData.rows.length; i++) {
          const tr = document.createElement('tr');
          for (let j = 0; j < tableData.rows[i].length; j++) {
            const td = document.createElement('td');
            td.setAttribute('contenteditable', 'true');
            td.setAttribute('data-row', i);
            td.setAttribute('data-col', j);
            
            if (tableData.rows[i][j]) {
              td.innerHTML = tableData.rows[i][j];
              // 既存データのリンク変換
              setTimeout(() => convertUrlsToLinks(td), 100);
            } else {
              td.innerHTML = createEmptyCell();
            }
            
            setupCellEvents(td, tableData.id);
            tr.appendChild(td);
          }
          table.appendChild(tr);
        }
        
        wrapper.appendChild(table);
        viewport.appendChild(wrapper);
        
        // ドラッグ機能を設定
        makeDraggable(wrapper);
        
        console.log('表を描画完了:', tableData.id);
      } catch (error) {
        console.error('表描画エラー:', error);
        showToast('表の描画に失敗しました', 'error');
      }
    }

    // 空のセルのHTML作成
    function createEmptyCell() {
      return `
        <div class="drop-zone" onclick="selectImage(this)">
          <div class="drop-zone-text">📷 画像追加</div>
          <div class="drop-zone-hint">クリックまたはドロップ</div>
        </div>
      `;
    }

    // セルイベント設定
    function setupCellEvents(td, tableId) {
      // フォーカス時
      td.addEventListener('focus', function() {
        if (this.innerHTML.includes('drop-zone')) {
          this.innerHTML = '';
        }
      });
      
      // フォーカスアウト時
      td.addEventListener('blur', function() {
        const row = parseInt(this.getAttribute('data-row'));
        const col = parseInt(this.getAttribute('data-col'));
        updateCellData(tableId, row, col, this.innerHTML);
        
        if (!this.innerHTML.trim()) {
          this.innerHTML = createEmptyCell();
        } else {
          convertUrlsToLinks(this);
        }
      });
      
      // エンターキー
      td.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.execCommand('insertHTML', false, '<br>');
        }
      });

      // ドラッグ&ドロップ
      td.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('drag-over');
      });

      td.addEventListener('dragleave', function(e) {
        this.classList.remove('drag-over');
      });

      td.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) {
          handleImageUpload(files[0], this, tableId);
        }
      });

      // ダブルクリックで画像選択
      td.addEventListener('dblclick', function() {
        selectImage(this);
      });
    }

    // 画像選択
    function selectImage(element) {
      const input = document.getElementById('image-file-input');
      input.onchange = function() {
        if (this.files.length > 0) {
          const cell = element.closest('td') || element;
          const tableId = cell.closest('.draggable-table').getAttribute('data-table-id');
          handleImageUpload(this.files[0], cell, tableId);
        }
      };
      input.click();
    }

    // 画像アップロード処理
    function handleImageUpload(file, cell, tableId) {
      try {
        if (file.size > 5 * 1024 * 1024) {
          showToast('画像サイズは5MB以下にしてください', 'error');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'cell-image';
          img.alt = file.name;
          
          img.addEventListener('click', function(event) {
            event.stopPropagation();
            selectImage(cell);
          });
          
          cell.innerHTML = '';
          cell.appendChild(img);
          cell.setAttribute('contenteditable', 'false');
          
          // データ更新
          const row = parseInt(cell.getAttribute('data-row'));
          const col = parseInt(cell.getAttribute('data-col'));
          updateCellData(tableId, row, col, cell.innerHTML);
          
          showToast('📸 画像をアップロードしました');
        };
        
        reader.onerror = function() {
          showToast('画像の読み込みに失敗しました', 'error');
        };
        
        reader.readAsDataURL(file);
      } catch (error) {
        console.error('画像アップロードエラー:', error);
        showToast('画像のアップロードに失敗しました', 'error');
      }
    }

    // URLをリンクに変換
    function convertUrlsToLinks(element) {
      if (document.activeElement === element) return;
      if (element.innerHTML.includes('<a href=') || element.innerHTML.includes('<img')) return;
      
      const urlRegex = /(https?:\/\/[^\s<>"]+)/gi;
      const text = element.innerHTML;
      
      const linkedText = text.replace(urlRegex, function(url) {
        const displayUrl = url.length > 25 ? url.substring(0, 22) + '...' : url;
        return `<a href="${url}" target="_blank" class="cell-link" onclick="event.stopPropagation()">${displayUrl}</a>`;
      });
      
      if (linkedText !== text) {
        element.innerHTML = linkedText;
        showToast('🔗 URLをリンクに変換しました');
      }
    }

    // ドラッグ機能
    function makeDraggable(element) {
      const header = element.querySelector('.table-header');
      
      header.addEventListener('mousedown', function(e) {
        // ボタンやタイトル入力をクリックした場合はドラッグしない
        if (e.target.closest('button') || e.target.closest('.table-title')) {
          return;
        }
        
        isDragging = true;
        dragTarget = element;
        element.classList.add('dragging');
        
        const rect = element.getBoundingClientRect();
        const viewportRect = document.getElementById('viewport').getBoundingClientRect();
        
        dragOffset.x = e.clientX - rect.left;
        dragOffset.y = e.clientY - rect.top;
        
        e.preventDefault();
      });
    }

    // グローバルマウスイベント
    document.addEventListener('mousemove', function(e) {
      if (isDragging && dragTarget) {
        const viewport = document.getElementById('viewport');
        const viewportRect = viewport.getBoundingClientRect();
        
        const x = e.clientX - viewportRect.left - dragOffset.x + viewport.scrollLeft;
        const y = e.clientY - viewportRect.top - dragOffset.y + viewport.scrollTop;
        
        dragTarget.style.left = Math.max(0, x) + 'px';
        dragTarget.style.top = Math.max(0, y) + 'px';
        
        // データ更新
        const tableId = dragTarget.getAttribute('data-table-id');
        const table = tables.find(t => t.id === tableId);
        if (table) {
          table.x = Math.max(0, x);
          table.y = Math.max(0, y);
        }
      }
    });

    document.addEventListener('mouseup', function() {
      if (isDragging && dragTarget) {
        dragTarget.classList.remove('dragging');
        isDragging = false;
        dragTarget = null;
      }
    });

    // パン機能
    function initPanFunction() {
      const viewport = document.getElementById('viewport');
      let isPanning = false;
      let startX, startY, scrollLeft, scrollTop;

      viewport.addEventListener('mousedown', function(e) {
        if (e.target.closest('.draggable-table') || e.target.closest('#controls')) {
          return;
        }
        
        isPanning = true;
        viewport.classList.add('panning');
        startX = e.pageX - viewport.offsetLeft;
        startY = e.pageY - viewport.offsetTop;
        scrollLeft = viewport.scrollLeft;
        scrollTop = viewport.scrollTop;
        e.preventDefault();
      });

      viewport.addEventListener('mouseleave', function() {
        isPanning = false;
        viewport.classList.remove('panning');
      });

      viewport.addEventListener('mouseup', function() {
        isPanning = false;
        viewport.classList.remove('panning');
      });

      viewport.addEventListener('mousemove', function(e) {
        if (!isPanning) return;
        e.preventDefault();
        const x = e.pageX - viewport.offsetLeft;
        const y = e.pageY - viewport.offsetTop;
        const walkX = (x - startX) * 1;
        const walkY = (y - startY) * 1;
        viewport.scrollLeft = scrollLeft - walkX;
        viewport.scrollTop = scrollTop - walkY;
      });
    }

    // セルデータ更新
    function updateCellData(tableId, row, col, content) {
      try {
        const table = tables.find(t => t.id === tableId);
        if (table && table.rows[row]) {
          table.rows[row][col] = content;
        }
      } catch (error) {
        console.error('セルデータ更新エラー:', error);
      }
    }

    // 表タイトル更新
    function updateTableTitle(tableId, title) {
      try {
        const table = tables.find(t => t.id === tableId);
        if (table) {
          table.title = title;
        }
      } catch (error) {
        console.error('タイトル更新エラー:', error);
      }
    }

    // 行追加
    function addRow(tableId) {
      try {
        const table = tables.find(t => t.id === tableId);
        if (table) {
          const colCount = table.rows[0].length;
          const newRow = new Array(colCount).fill('');
          table.rows.push(newRow);
          refreshTable(tableId);
          showToast('行を追加しました');
        }
      } catch (error) {
        console.error('行追加エラー:', error);
        showToast('行の追加に失敗しました', 'error');
      }
    }

    // 列追加
    function addColumn(tableId) {
      try {
        const table = tables.find(t => t.id === tableId);
        if (table) {
          table.rows.forEach(row => row.push(''));
          refreshTable(tableId);
          showToast('列を追加しました');
        }
      } catch (error) {
        console.error('列追加エラー:', error);
        showToast('列の追加に失敗しました', 'error');
      }
    }

    // 行削除
    function removeRow(tableId) {
      try {
        const table = tables.find(t => t.id === tableId);
        if (table && table.rows.length > 1) {
          table.rows.pop();
          refreshTable(tableId);
          showToast('行を削除しました');
        }
      } catch (error) {
        console.error('行削除エラー:', error);
      }
    }

    // 列削除
    function removeColumn(tableId) {
      try {
        const table = tables.find(t => t.id === tableId);
        if (table && table.rows[0].length > 1) {
          table.rows.forEach(row => row.pop());
          refreshTable(tableId);
          showToast('列を削除しました');
        }
      } catch (error) {
        console.error('列削除エラー:', error);
      }
    }

    // 表削除
    function deleteTable(tableId) {
      try {
        if (confirm('この表を削除しますか？')) {
          tables = tables.filter(t => t.id !== tableId);
          const wrapper = document.querySelector(`[data-table-id="${tableId}"]`);
          if (wrapper) {
            wrapper.remove();
          }
          showToast('表を削除しました');
        }
      } catch (error) {
        console.error('表削除エラー:', error);
      }
    }

    // 表を再描画
    function refreshTable(tableId) {
      try {
        const wrapper = document.querySelector(`[data-table-id="${tableId}"]`);
        const table = tables.find(t => t.id === tableId);
        if (wrapper && table) {
          const x = parseInt(wrapper.style.left);
          const y = parseInt(wrapper.style.top);
          table.x = x;
          table.y = y;
          wrapper.remove();
          renderTable(table);
        }
      } catch (error) {
        console.error('表再描画エラー:', error);
      }
    }

    // ワークスペース拡張
    function expandWorkspace() {
      const bg = document.getElementById('background');
      bg.style.width = (bg.offsetWidth + 1000) + 'px';
      bg.style.height = (bg.offsetHeight + 1000) + 'px';
      showToast('📄 ワークスペースを拡張しました');
    }

    // ローカルストレージに保存
    function saveToLocalStorage() {
      try {
        localStorage.setItem('tableEditorData', JSON.stringify(tables));
        localStorage.setItem('tableEditorSaveTime', new Date().toISOString());
        showToast('💾 データを保存しました');
        console.log('保存完了:', tables);
      } catch (error) {
        console.error('保存エラー:', error);
        showToast('保存に失敗しました', 'error');
      }
    }

    // ローカルストレージから復元
    function loadFromLocalStorage() {
      try {
        const savedData = localStorage.getItem('tableEditorData');
        if (savedData) {
          tables = JSON.parse(savedData);
          document.querySelectorAll('.draggable-table').forEach(el => el.remove());
          tables.forEach(table => renderTable(table));
          tableCount = tables.length;
          showToast('📂 データを復元しました');
          console.log('復元完了:', tables);
        } else {
          showToast('保存されたデータがありません', 'error');
        }
      } catch (error) {
        console.error('復元エラー:', error);
        showToast('データの復元に失敗しました', 'error');
      }
    }

    // JSONエクスポート
    function exportToJSON() {
      try {
        if (tables.length === 0) {
          showToast('エクスポートする表がありません', 'error');
          return;
        }
        
        const exportData = {
          version: '2.0',
          exportDate: new Date().toISOString(),
          tables: tables
        };
        

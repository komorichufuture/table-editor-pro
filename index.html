<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¡¨ã‚¨ãƒ‡ã‚£ã‚¿ Pro - æ©Ÿèƒ½å®Œå…¨ç‰ˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      overflow: auto;
    }

    #viewport {
      position: relative;
      width: 100%;
      min-height: 100vh;
      overflow: auto;
      cursor: grab;
    }

    #viewport:active {
      cursor: grabbing;
    }

    #viewport.panning {
      cursor: grabbing;
    }

    #background {
      position: absolute;
      top: 0;
      left: 0;
      width: 3000px;
      height: 2000px;
      background: 
        linear-gradient(to right, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
      background-size: 40px 40px;
      z-index: 0;
    }
    
    #controls {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      max-width: 350px;
    }
    
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
    }
    
    .btn.secondary {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      color: #744210;
    }
    
    .btn.danger {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
      color: white;
    }
    
    .draggable-table {
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid rgba(102, 126, 234, 0.3);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      cursor: move;
      z-index: 10;
      min-width: 200px;
      transition: all 0.3s ease;
    }

    .draggable-table:hover {
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
      transform: translateY(-3px);
    }

    .draggable-table.dragging {
      transform: rotate(2deg) scale(1.02);
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
      z-index: 100;
      cursor: grabbing;
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: move;
    }
    
    .table-title {
      font-size: 16px;
      font-weight: bold;
      color: #4c51bf;
      background: rgba(102, 126, 234, 0.1);
      padding: 8px 15px;
      border-radius: 8px;
      border: none;
      outline: none;
      cursor: text;
    }
    
    .table-controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .table-controls .btn {
      font-size: 11px;
      padding: 6px 10px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    td {
      border: 2px solid rgba(102, 126, 234, 0.2);
      min-width: 120px;
      min-height: 80px;
      padding: 8px;
      text-align: center;
      vertical-align: middle;
      background: white;
      transition: all 0.2s ease;
      position: relative;
    }
    
    td:hover {
      background: rgba(102, 126, 234, 0.05);
      border-color: rgba(102, 126, 234, 0.4);
    }
    
    td[contenteditable="true"] {
      outline: none;
      cursor: text;
    }
    
    td[contenteditable="true"]:focus {
      background: rgba(102, 126, 234, 0.1);
      border-color: rgba(102, 126, 234, 0.6);
      box-shadow: inset 0 0 0 2px rgba(102, 126, 234, 0.3);
    }

    /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ */
    .drop-zone {
      border: 2px dashed rgba(102, 126, 234, 0.4);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      background: rgba(102, 126, 234, 0.05);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .drop-zone:hover,
    .drop-zone.drag-over {
      border-color: rgba(102, 126, 234, 0.6);
      background: rgba(102, 126, 234, 0.1);
      transform: scale(1.02);
    }

    .drop-zone-text {
      color: #667eea;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .drop-zone-hint {
      color: #999;
      font-size: 12px;
    }

    /* ç”»åƒã‚¹ã‚¿ã‚¤ãƒ« */
    .cell-image {
      max-width: 100px;
      max-height: 60px;
      border-radius: 6px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .cell-image:hover {
      transform: scale(1.1);
    }

    .placeholder {
      color: #999;
      font-style: italic;
      font-size: 14px;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
      z-index: 1001;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      font-weight: 600;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
    }
    
    .file-input {
      display: none;
    }

    /* ãƒªãƒ³ã‚¯ã‚¹ã‚¿ã‚¤ãƒ« */
    .cell-link {
      color: #667eea;
      text-decoration: none;
      border-bottom: 1px dashed #667eea;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .cell-link:hover {
      color: #4c51bf;
      border-bottom: 1px solid #4c51bf;
    }
    
    @media (max-width: 768px) {
      #controls {
        position: relative;
        margin: 15px;
        width: calc(100% - 30px);
        max-width: none;
      }
      
      .draggable-table {
        position: relative;
        margin: 20px auto;
        width: calc(100% - 40px);
        cursor: default;
        transform: none !important;
      }

      .table-header {
        cursor: default;
      }
      
      .btn {
        font-size: 12px;
        padding: 10px 15px;
      }
      
      td {
        min-width: 80px;
        min-height: 60px;
        font-size: 12px;
      }

      .cell-image {
        max-width: 70px;
        max-height: 40px;
      }
    }
  </style>
</head>
<body>
  <div id="viewport">
    <div id="background"></div>
    
    <div id="controls">
      <button class="btn" onclick="createNewTable()">ğŸ“Š æ–°ã—ã„è¡¨</button>
      <button class="btn secondary" onclick="saveToLocalStorage()">ğŸ’¾ ä¿å­˜</button>
      <button class="btn secondary" onclick="loadFromLocalStorage()">ğŸ“‚ å¾©å…ƒ</button>
      <button class="btn" onclick="exportToJSON()">ğŸ“¤ JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="btn" onclick="importFromJSON()">ğŸ“ JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      <button class="btn" onclick="expandWorkspace()">ğŸ“„ æ‹¡å¼µ</button>
      <button class="btn danger" onclick="clearAllTables()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <input type="file" id="json-file-input" class="file-input" accept=".json">
  <input type="file" id="image-file-input" class="file-input" accept="image/*">

  <script>
    let tableCount = 0;
    let tables = [];
    let dragTarget = null;
    let isDragging = false;
    let dragOffset = { x: 0, y: 0 };

    // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // æ–°ã—ã„è¡¨ã‚’ä½œæˆ
    function createNewTable() {
      try {
        tableCount++;
        const tableId = `table-${Date.now()}`;
        
        const tableData = {
          id: tableId,
          title: `è¡¨ ${tableCount}`,
          x: 200 + (tableCount * 50),
          y: 150 + (tableCount * 50),
          rows: [
            ['', '', ''],
            ['', '', ''],
            ['', '', '']
          ]
        };
        
        tables.push(tableData);
        renderTable(tableData);
        showToast('ğŸ“Š æ–°ã—ã„è¡¨ã‚’ä½œæˆã—ã¾ã—ãŸ');
        console.log('æ–°ã—ã„è¡¨ã‚’ä½œæˆ:', tableData);
      } catch (error) {
        console.error('è¡¨ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        showToast('è¡¨ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    // è¡¨ã‚’HTMLã«æç”»
    function renderTable(tableData) {
      try {
        const viewport = document.getElementById('viewport');
        
        const wrapper = document.createElement('div');
        wrapper.className = 'draggable-table';
        wrapper.setAttribute('data-table-id', tableData.id);
        wrapper.style.left = `${tableData.x}px`;
        wrapper.style.top = `${tableData.y}px`;
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ï¼‰
        const header = document.createElement('div');
        header.className = 'table-header';
        
        const titleInput = document.createElement('input');
        titleInput.className = 'table-title';
        titleInput.value = tableData.title;
        titleInput.addEventListener('input', function() {
          updateTableTitle(tableData.id, this.value);
        });
        titleInput.addEventListener('mousedown', function(e) {
          e.stopPropagation(); // ã‚¿ã‚¤ãƒˆãƒ«ç·¨é›†æ™‚ã¯ãƒ‰ãƒ©ãƒƒã‚°ã—ãªã„
        });
        
        const controls = document.createElement('div');
        controls.className = 'table-controls';
        controls.innerHTML = `
          <button class="btn" onclick="addRow('${tableData.id}')">â•è¡Œ</button>
          <button class="btn" onclick="addColumn('${tableData.id}')">â•åˆ—</button>
          <button class="btn danger" onclick="removeRow('${tableData.id}')">â–è¡Œ</button>
          <button class="btn danger" onclick="removeColumn('${tableData.id}')">â–åˆ—</button>
          <button class="btn danger" onclick="deleteTable('${tableData.id}')">ğŸ—‘ï¸</button>
        `;
        
        header.appendChild(titleInput);
        header.appendChild(controls);
        wrapper.appendChild(header);
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«
        const table = document.createElement('table');
        table.id = `table-${tableData.id}`;
        
        for (let i = 0; i < tableData.rows.length; i++) {
          const tr = document.createElement('tr');
          for (let j = 0; j < tableData.rows[i].length; j++) {
            const td = document.createElement('td');
            td.setAttribute('contenteditable', 'true');
            td.setAttribute('data-row', i);
            td.setAttribute('data-col', j);
            
            if (tableData.rows[i][j]) {
              td.innerHTML = tableData.rows[i][j];
              // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ãƒªãƒ³ã‚¯å¤‰æ›
              setTimeout(() => convertUrlsToLinks(td), 100);
            } else {
              td.innerHTML = createEmptyCell();
            }
            
            setupCellEvents(td, tableData.id);
            tr.appendChild(td);
          }
          table.appendChild(tr);
        }
        
        wrapper.appendChild(table);
        viewport.appendChild(wrapper);
        
        // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã‚’è¨­å®š
        makeDraggable(wrapper);
        
        console.log('è¡¨ã‚’æç”»å®Œäº†:', tableData.id);
      } catch (error) {
        console.error('è¡¨æç”»ã‚¨ãƒ©ãƒ¼:', error);
        showToast('è¡¨ã®æç”»ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    // ç©ºã®ã‚»ãƒ«ã®HTMLä½œæˆ
    function createEmptyCell() {
      return `
        <div class="drop-zone" onclick="selectImage(this)">
          <div class="drop-zone-text">ğŸ“· ç”»åƒè¿½åŠ </div>
          <div class="drop-zone-hint">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ­ãƒƒãƒ—</div>
        </div>
      `;
    }

    // ã‚»ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    function setupCellEvents(td, tableId) {
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚
      td.addEventListener('focus', function() {
        if (this.innerHTML.includes('drop-zone')) {
          this.innerHTML = '';
        }
      });
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¢ã‚¦ãƒˆæ™‚
      td.addEventListener('blur', function() {
        const row = parseInt(this.getAttribute('data-row'));
        const col = parseInt(this.getAttribute('data-col'));
        updateCellData(tableId, row, col, this.innerHTML);
        
        if (!this.innerHTML.trim()) {
          this.innerHTML = createEmptyCell();
        } else {
          convertUrlsToLinks(this);
        }
      });
      
      // ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼
      td.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.execCommand('insertHTML', false, '<br>');
        }
      });

      // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
      td.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('drag-over');
      });

      td.addEventListener('dragleave', function(e) {
        this.classList.remove('drag-over');
      });

      td.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) {
          handleImageUpload(files[0], this, tableId);
        }
      });

      // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç”»åƒé¸æŠ
      td.addEventListener('dblclick', function() {
        selectImage(this);
      });
    }

    // ç”»åƒé¸æŠ
    function selectImage(element) {
      const input = document.getElementById('image-file-input');
      input.onchange = function() {
        if (this.files.length > 0) {
          const cell = element.closest('td') || element;
          const tableId = cell.closest('.draggable-table').getAttribute('data-table-id');
          handleImageUpload(this.files[0], cell, tableId);
        }
      };
      input.click();
    }

    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
    function handleImageUpload(file, cell, tableId) {
      try {
        if (file.size > 5 * 1024 * 1024) {
          showToast('ç”»åƒã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„', 'error');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'cell-image';
          img.alt = file.name;
          
          img.addEventListener('click', function(event) {
            event.stopPropagation();
            selectImage(cell);
          });
          
          cell.innerHTML = '';
          cell.appendChild(img);
          cell.setAttribute('contenteditable', 'false');
          
          // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
          const row = parseInt(cell.getAttribute('data-row'));
          const col = parseInt(cell.getAttribute('data-col'));
          updateCellData(tableId, row, col, cell.innerHTML);
          
          showToast('ğŸ“¸ ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
        };
        
        reader.onerror = function() {
          showToast('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        };
        
        reader.readAsDataURL(file);
      } catch (error) {
        console.error('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        showToast('ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    // URLã‚’ãƒªãƒ³ã‚¯ã«å¤‰æ›
    function convertUrlsToLinks(element) {
      if (document.activeElement === element) return;
      if (element.innerHTML.includes('<a href=') || element.innerHTML.includes('<img')) return;
      
      const urlRegex = /(https?:\/\/[^\s<>"]+)/gi;
      const text = element.innerHTML;
      
      const linkedText = text.replace(urlRegex, function(url) {
        const displayUrl = url.length > 25 ? url.substring(0, 22) + '...' : url;
        return `<a href="${url}" target="_blank" class="cell-link" onclick="event.stopPropagation()">${displayUrl}</a>`;
      });
      
      if (linkedText !== text) {
        element.innerHTML = linkedText;
        showToast('ğŸ”— URLã‚’ãƒªãƒ³ã‚¯ã«å¤‰æ›ã—ã¾ã—ãŸ');
      }
    }

    // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½
    function makeDraggable(element) {
      const header = element.querySelector('.table-header');
      
      header.addEventListener('mousedown', function(e) {
        // ãƒœã‚¿ãƒ³ã‚„ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯ãƒ‰ãƒ©ãƒƒã‚°ã—ãªã„
        if (e.target.closest('button') || e.target.closest('.table-title')) {
          return;
        }
        
        isDragging = true;
        dragTarget = element;
        element.classList.add('dragging');
        
        const rect = element.getBoundingClientRect();
        const viewportRect = document.getElementById('viewport').getBoundingClientRect();
        
        dragOffset.x = e.clientX - rect.left;
        dragOffset.y = e.clientY - rect.top;
        
        e.preventDefault();
      });
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
    document.addEventListener('mousemove', function(e) {
      if (isDragging && dragTarget) {
        const viewport = document.getElementById('viewport');
        const viewportRect = viewport.getBoundingClientRect();
        
        const x = e.clientX - viewportRect.left - dragOffset.x + viewport.scrollLeft;
        const y = e.clientY - viewportRect.top - dragOffset.y + viewport.scrollTop;
        
        dragTarget.style.left = Math.max(0, x) + 'px';
        dragTarget.style.top = Math.max(0, y) + 'px';
        
        // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        const tableId = dragTarget.getAttribute('data-table-id');
        const table = tables.find(t => t.id === tableId);
        if (table) {
          table.x = Math.max(0, x);
          table.y = Math.max(0, y);
        }
      }
    });

    document.addEventListener('mouseup', function() {
      if (isDragging && dragTarget) {
        dragTarget.classList.remove('dragging');
        isDragging = false;
        dragTarget = null;
      }
    });

    // ãƒ‘ãƒ³æ©Ÿèƒ½
    function initPanFunction() {
      const viewport = document.getElementById('viewport');
      let isPanning = false;
      let startX, startY, scrollLeft, scrollTop;

      viewport.addEventListener('mousedown', function(e) {
        if (e.target.closest('.draggable-table') || e.target.closest('#controls')) {
          return;
        }
        
        isPanning = true;
        viewport.classList.add('panning');
        startX = e.pageX - viewport.offsetLeft;
        startY = e.pageY - viewport.offsetTop;
        scrollLeft = viewport.scrollLeft;
        scrollTop = viewport.scrollTop;
        e.preventDefault();
      });

      viewport.addEventListener('mouseleave', function() {
        isPanning = false;
        viewport.classList.remove('panning');
      });

      viewport.addEventListener('mouseup', function() {
        isPanning = false;
        viewport.classList.remove('panning');
      });

      viewport.addEventListener('mousemove', function(e) {
        if (!isPanning) return;
        e.preventDefault();
        const x = e.pageX - viewport.offsetLeft;
        const y = e.pageY - viewport.offsetTop;
        const walkX = (x - startX) * 1;
        const walkY = (y - startY) * 1;
        viewport.scrollLeft = scrollLeft - walkX;
        viewport.scrollTop = scrollTop - walkY;
      });
    }

    // ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
    function updateCellData(tableId, row, col, content) {
      try {
        const table = tables.find(t => t.id === tableId);
        if (table && table.rows[row]) {
          table.rows[row][col] = content;
        }
      } catch (error) {
        console.error('ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // è¡¨ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
    function updateTableTitle(tableId, title) {
      try {
        const table = tables.find(t => t.id === tableId);
        if (table) {
          table.title = title;
        }
      } catch (error) {
        console.error('ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // è¡Œè¿½åŠ 
    function addRow(tableId) {
      try {
        const table = tables.find(t => t.id === tableId);
        if (table) {
          const colCount = table.rows[0].length;
          const newRow = new Array(colCount).fill('');
          table.rows.push(newRow);
          refreshTable(tableId);
          showToast('è¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('è¡Œè¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
        showToast('è¡Œã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    // åˆ—è¿½åŠ 
    function addColumn(tableId) {
      try {
        const table = tables.find(t => t.id === tableId);
        if (table) {
          table.rows.forEach(row => row.push(''));
          refreshTable(tableId);
          showToast('åˆ—ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('åˆ—è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
        showToast('åˆ—ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    // è¡Œå‰Šé™¤
    function removeRow(tableId) {
      try {
        const table = tables.find(t => t.id === tableId);
        if (table && table.rows.length > 1) {
          table.rows.pop();
          refreshTable(tableId);
          showToast('è¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('è¡Œå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // åˆ—å‰Šé™¤
    function removeColumn(tableId) {
      try {
        const table = tables.find(t => t.id === tableId);
        if (table && table.rows[0].length > 1) {
          table.rows.forEach(row => row.pop());
          refreshTable(tableId);
          showToast('åˆ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('åˆ—å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // è¡¨å‰Šé™¤
    function deleteTable(tableId) {
      try {
        if (confirm('ã“ã®è¡¨ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          tables = tables.filter(t => t.id !== tableId);
          const wrapper = document.querySelector(`[data-table-id="${tableId}"]`);
          if (wrapper) {
            wrapper.remove();
          }
          showToast('è¡¨ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('è¡¨å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // è¡¨ã‚’å†æç”»
    function refreshTable(tableId) {
      try {
        const wrapper = document.querySelector(`[data-table-id="${tableId}"]`);
        const table = tables.find(t => t.id === tableId);
        if (wrapper && table) {
          const x = parseInt(wrapper.style.left);
          const y = parseInt(wrapper.style.top);
          table.x = x;
          table.y = y;
          wrapper.remove();
          renderTable(table);
        }
      } catch (error) {
        console.error('è¡¨å†æç”»ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹æ‹¡å¼µ
    function expandWorkspace() {
      const bg = document.getElementById('background');
      bg.style.width = (bg.offsetWidth + 1000) + 'px';
      bg.style.height = (bg.offsetHeight + 1000) + 'px';
      showToast('ğŸ“„ ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’æ‹¡å¼µã—ã¾ã—ãŸ');
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    function saveToLocalStorage() {
      try {
        localStorage.setItem('tableEditorData', JSON.stringify(tables));
        localStorage.setItem('tableEditorSaveTime', new Date().toISOString());
        showToast('ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        console.log('ä¿å­˜å®Œäº†:', tables);
      } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¾©å…ƒ
    function loadFromLocalStorage() {
      try {
        const savedData = localStorage.getItem('tableEditorData');
        if (savedData) {
          tables = JSON.parse(savedData);
          document.querySelectorAll('.draggable-table').forEach(el => el.remove());
          tables.forEach(table => renderTable(table));
          tableCount = tables.length;
          showToast('ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
          console.log('å¾©å…ƒå®Œäº†:', tables);
        } else {
          showToast('ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        }
      } catch (error) {
        console.error('å¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
        showToast('ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    // JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    function exportToJSON() {
      try {
        if (tables.length === 0) {
          showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹è¡¨ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
          return;
        }
        
        const exportData = {
          version: '2.0',
          exportDate: new Date().toISOString(),
          tables: tables
        };
        
